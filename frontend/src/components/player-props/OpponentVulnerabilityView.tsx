'use client'

import { useState } from 'react'
import { OpponentVulnerabilityByPosition } from '@/lib/queries'

interface OpponentVulnerabilityViewProps {
  absentPlayer: {
    playerId: number
    playerName: string
    teamAbbr: string
    gamesMissed: number
  }
  vulnerabilities: OpponentVulnerabilityByPosition[]
}

// Helper to safely convert PostgreSQL numeric to number
const toNum = (val: number | string | null): number => {
  if (val === null) return 0
  return typeof val === 'string' ? parseFloat(val) : val
}

type StatType = 'pts' | 'fga' | 'fgpct'

const statConfig: Record<StatType, { label: string; shortLabel: string; unit: string }> = {
  pts: { label: 'Points', shortLabel: 'PTS', unit: '' },
  fga: { label: 'Tirs tentés', shortLabel: 'FGA', unit: '' },
  fgpct: { label: 'Réussite', shortLabel: 'FG%', unit: '%' },
}

const positionOrder = ['C', 'PF', 'SF', 'SG', 'PG']

export function OpponentVulnerabilityView({ absentPlayer, vulnerabilities }: OpponentVulnerabilityViewProps) {
  const [activeStat, setActiveStat] = useState<StatType>('pts')

  // Get stat values based on active stat type
  const getStatValues = (vuln: OpponentVulnerabilityByPosition) => {
    switch (activeStat) {
      case 'pts':
        return {
          with: toNum(vuln.pts_with),
          without: toNum(vuln.pts_without),
          boost: toNum(vuln.pts_boost),
        }
      case 'fga':
        return {
          with: toNum(vuln.fga_with),
          without: toNum(vuln.fga_without),
          boost: toNum(vuln.fga_boost),
        }
      case 'fgpct':
        return {
          with: toNum(vuln.fgpct_with),
          without: toNum(vuln.fgpct_without),
          boost: toNum(vuln.fgpct_boost),
        }
    }
  }

  // Get boost color class
  const getBoostColor = (boost: number, stat: StatType) => {
    const threshold = stat === 'fgpct' ? 2 : stat === 'fga' ? 1 : 2
    const smallThreshold = stat === 'fgpct' ? 1 : stat === 'fga' ? 0.5 : 1

    if (boost >= threshold) return 'text-emerald-400'
    if (boost >= smallThreshold) return 'text-emerald-500'
    if (boost > 0) return 'text-emerald-600'
    if (boost <= -threshold) return 'text-red-400'
    if (boost < 0) return 'text-red-500'
    return 'text-zinc-400'
  }

  // Get row background for significant changes
  const getRowBg = (boost: number, stat: StatType) => {
    const threshold = stat === 'fgpct' ? 2 : stat === 'fga' ? 1 : 2
    if (boost >= threshold) return 'bg-emerald-500/5'
    if (boost <= -threshold) return 'bg-red-500/5'
    return ''
  }

  // Sort by position order, then by boost
  const sortedVulnerabilities = [...vulnerabilities].sort((a, b) => {
    const aStats = getStatValues(a)
    const bStats = getStatValues(b)
    return bStats.boost - aStats.boost
  })

  // Filter to known positions and sort by boost
  const filteredVulnerabilities = sortedVulnerabilities.filter(v =>
    positionOrder.includes(v.position) || v.position === 'Unknown'
  )

  const threshold = activeStat === 'fgpct' ? 2 : activeStat === 'fga' ? 1 : 2

  if (vulnerabilities.length === 0) {
    return (
      <div className="bg-zinc-900/50 md:border md:border-zinc-800 md:rounded-xl p-4 md:p-8 text-center">
        <p className="text-zinc-400 text-sm md:text-base">Données insuffisantes pour l&apos;analyse d&apos;impact adversaire</p>
        <p className="text-xs md:text-sm text-zinc-500 mt-1">Minimum 3 matchs avec et sans le joueur requis</p>
      </div>
    )
  }

  return (
    <div className="space-y-3 md:space-y-4">
      {/* Header */}
      <div className="bg-zinc-900/50 md:border md:border-zinc-800 rounded-lg md:rounded-xl p-3 md:p-4">
        {/* Mobile: Compact layout */}
        <div className="md:hidden">
          <div className="flex items-center justify-between">
            <div>
              <span className="text-zinc-400 text-xs">Sans </span>
              <span className="text-white font-bold">{absentPlayer.playerName}</span>
            </div>
            <div className="text-right">
              <span className="text-lg font-mono font-bold text-white">{absentPlayer.gamesMissed}</span>
              <span className="text-zinc-500 text-xs ml-1">MJ</span>
            </div>
          </div>
          <div className="text-xs text-zinc-500 mt-1">Impact sur les positions adverses</div>
        </div>
        {/* Desktop: Full horizontal layout */}
        <div className="hidden md:flex items-center justify-between">
          <div className="flex items-center gap-2">
            <span className="text-zinc-400 text-sm">Sans</span>
            <span className="text-white font-bold">{absentPlayer.playerName}</span>
            <span className="text-zinc-500 text-sm">({absentPlayer.teamAbbr})</span>
            <span className="text-zinc-600 mx-2">•</span>
            <span className="text-zinc-400 text-sm">Impact sur les positions adverses</span>
          </div>
          <div className="flex items-center gap-2">
            <span className="text-2xl font-mono font-bold text-white">{absentPlayer.gamesMissed}</span>
            <span className="text-zinc-500 text-sm">matchs</span>
          </div>
        </div>
      </div>

      {/* Stat Tabs */}
      <div className="-mx-4 md:mx-0 px-4 md:px-0">
        <div className="flex gap-1 md:gap-2 overflow-x-auto pb-2 scrollbar-hide">
          {(Object.keys(statConfig) as StatType[]).map((stat) => (
            <button
              key={stat}
              onClick={() => setActiveStat(stat)}
              className={`px-3 md:px-4 py-2 rounded-lg text-xs md:text-sm font-medium transition-colors whitespace-nowrap flex-shrink-0 min-w-[44px] ${
                activeStat === stat
                  ? 'bg-white text-black'
                  : 'bg-zinc-800 text-zinc-400 active:bg-zinc-700'
              }`}
            >
              {statConfig[stat].shortLabel}
            </button>
          ))}
        </div>
      </div>

      {/* Mobile: Card layout */}
      <div className="md:hidden space-y-2">
        {filteredVulnerabilities.map((vuln) => {
          const stats = getStatValues(vuln)
          const isSignificant = stats.boost >= threshold

          return (
            <div
              key={vuln.position}
              className={`bg-zinc-900/50 rounded-lg p-3 ${getRowBg(stats.boost, activeStat)}`}
            >
              {/* Row 1: Position + Boost */}
              <div className="flex items-center justify-between mb-1.5">
                <div className="flex items-center gap-2">
                  <span className="text-white font-bold text-base">{vuln.position}</span>
                  {isSignificant && (
                    <span className="text-[9px] px-1.5 py-0.5 bg-emerald-500/20 text-emerald-400 rounded font-medium">
                      VULNÉRABLE
                    </span>
                  )}
                </div>
                <span className={`font-mono font-bold text-base ${getBoostColor(stats.boost, activeStat)}`}>
                  {stats.boost > 0 ? '+' : ''}{stats.boost.toFixed(1)}{statConfig[activeStat].unit}
                  {stats.boost >= threshold && <span className="text-xs ml-0.5">↑</span>}
                </span>
              </div>
              {/* Row 2: Stats comparison */}
              <div className="flex items-center gap-3 text-xs">
                <div className="flex items-center gap-1">
                  <span className="text-zinc-500">Sans:</span>
                  <span className="text-white font-mono font-medium">
                    {stats.without.toFixed(1)}{statConfig[activeStat].unit}
                  </span>
                </div>
                <span className="text-zinc-700">vs</span>
                <div className="flex items-center gap-1">
                  <span className="text-zinc-500">Avec:</span>
                  <span className="text-zinc-400 font-mono">
                    {stats.with.toFixed(1)}{statConfig[activeStat].unit}
                  </span>
                </div>
                <span className="text-zinc-600 ml-auto font-mono text-[10px]">{vuln.games_without} MJ</span>
              </div>
            </div>
          )
        })}
      </div>

      {/* Desktop: Table layout */}
      <div className="hidden md:block bg-zinc-900/50 border border-zinc-800 rounded-xl overflow-hidden">
        {/* Header */}
        <div className="grid grid-cols-12 gap-2 px-4 py-3 border-b border-zinc-800 bg-zinc-900/80">
          <div className="col-span-2 text-[10px] uppercase tracking-wider text-zinc-500 font-medium">
            Position
          </div>
          <div className="col-span-3 text-[10px] uppercase tracking-wider text-zinc-500 font-medium text-right">
            Sans {absentPlayer.playerName.split(' ')[1] || absentPlayer.playerName}
          </div>
          <div className="col-span-3 text-[10px] uppercase tracking-wider text-zinc-500 font-medium text-right">
            Avec
          </div>
          <div className="col-span-2 text-[10px] uppercase tracking-wider text-zinc-500 font-medium text-right">
            Boost
          </div>
          <div className="col-span-2 text-[10px] uppercase tracking-wider text-zinc-500 font-medium text-right">
            Sample
          </div>
        </div>

        {/* Rows */}
        {filteredVulnerabilities.map((vuln) => {
          const stats = getStatValues(vuln)
          const isSignificant = stats.boost >= threshold

          return (
            <div
              key={vuln.position}
              className={`grid grid-cols-12 gap-2 px-4 py-3 items-center border-b border-zinc-800/50 last:border-b-0 hover:bg-zinc-800/30 transition-colors ${getRowBg(stats.boost, activeStat)}`}
            >
              {/* Position + badge */}
              <div className="col-span-2 flex items-center gap-2">
                <span className="text-white font-bold text-lg">{vuln.position}</span>
                {isSignificant && (
                  <span className="text-[9px] px-1.5 py-0.5 bg-emerald-500/20 text-emerald-400 rounded font-medium">
                    VULNÉRABLE
                  </span>
                )}
              </div>

              {/* Stats sans (mis en avant) */}
              <div className="col-span-3 text-right">
                <span className="text-white font-mono font-bold">
                  {stats.without.toFixed(1)}{statConfig[activeStat].unit}
                </span>
              </div>

              {/* Stats avec */}
              <div className="col-span-3 text-right">
                <span className="text-zinc-500 font-mono">
                  {stats.with.toFixed(1)}{statConfig[activeStat].unit}
                </span>
              </div>

              {/* Boost */}
              <div className="col-span-2 text-right">
                <span className={`font-mono font-bold ${getBoostColor(stats.boost, activeStat)}`}>
                  {stats.boost > 0 ? '+' : ''}{stats.boost.toFixed(1)}{statConfig[activeStat].unit}
                  {stats.boost >= threshold && <span className="ml-1">↑</span>}
                </span>
              </div>

              {/* Sample size */}
              <div className="col-span-2 text-right">
                <span className="text-xs text-zinc-500 font-mono">
                  {vuln.games_without}/{vuln.games_with}
                </span>
              </div>
            </div>
          )
        })}
      </div>

      {/* Footer */}
      <div className="text-center">
        <p className="text-[10px] text-zinc-600">
          Joueurs adverses avec 15+ min • Min 3 matchs • Trié par boost {statConfig[activeStat].shortLabel}
        </p>
      </div>
    </div>
  )
}
