# =============================================================================
# Stat Discute - Python ETL Dockerfile
# =============================================================================
# Runs scheduled ETL jobs for NBA data collection and analytics
# Uses supercronic for scheduling (non-root compatible)
# =============================================================================
# SECURITY HARDENING: 2026-01-09
# - Uses supercronic instead of cron (runs as non-root)
# - Creates dedicated etluser (UID 1001)
# - Removes wget/curl after setup to reduce attack surface
# =============================================================================

FROM python:3.12-slim

WORKDIR /app

# -----------------------------------------------------------------------------
# Install system dependencies
# -----------------------------------------------------------------------------
RUN apt-get update && apt-get install -y --no-install-recommends \
    # PostgreSQL client library
    libpq-dev \
    # Build tools for Python packages
    gcc \
    # Utilities (temporarily needed for supercronic download)
    curl \
    && rm -rf /var/lib/apt/lists/*

# -----------------------------------------------------------------------------
# Install supercronic (cron replacement that runs as non-root)
# -----------------------------------------------------------------------------
ENV SUPERCRONIC_URL=https://github.com/aptible/supercronic/releases/download/v0.2.29/supercronic-linux-amd64 \
    SUPERCRONIC_SHA1SUM=cd48d45c4b10f3f0bfdd3a57d054cd05ac96812b \
    SUPERCRONIC=/usr/local/bin/supercronic

RUN curl -fsSLO "$SUPERCRONIC_URL" \
    && echo "${SUPERCRONIC_SHA1SUM}  supercronic-linux-amd64" | sha1sum -c - \
    && chmod +x supercronic-linux-amd64 \
    && mv supercronic-linux-amd64 "$SUPERCRONIC"

# -----------------------------------------------------------------------------
# Install Python dependencies
# -----------------------------------------------------------------------------
COPY 1.DATABASE/requirements.txt .

# Install with pip, no cache to reduce image size
RUN pip install --no-cache-dir -r requirements.txt

# -----------------------------------------------------------------------------
# Create non-root user for security
# -----------------------------------------------------------------------------
RUN groupadd --system --gid 1001 etlgroup \
    && useradd --system --uid 1001 --gid etlgroup --home /app --shell /bin/bash etluser

# -----------------------------------------------------------------------------
# Copy application code
# -----------------------------------------------------------------------------
# Copy ETL scripts
COPY 1.DATABASE/etl/ ./etl/

# Copy config directory
COPY 1.DATABASE/config/ ./config/

# -----------------------------------------------------------------------------
# Setup supercronic scheduling
# -----------------------------------------------------------------------------
# Copy crontab file for supercronic
COPY docker/etl-crontab /app/crontab

# -----------------------------------------------------------------------------
# Create directories and set permissions
# -----------------------------------------------------------------------------
RUN mkdir -p /app/logs /app/sessions \
    && chown -R etluser:etlgroup /app \
    && chmod 755 /app/logs /app/sessions

# -----------------------------------------------------------------------------
# Security: Remove curl after supercronic installation
# -----------------------------------------------------------------------------
RUN apt-get purge -y curl \
    && apt-get autoremove -y \
    && rm -rf /var/lib/apt/lists/*

# -----------------------------------------------------------------------------
# Environment setup
# -----------------------------------------------------------------------------
# Ensure Python output is sent straight to terminal
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1

# -----------------------------------------------------------------------------
# Switch to non-root user
# -----------------------------------------------------------------------------
USER etluser

# Health check - verify supercronic is running
HEALTHCHECK --interval=60s --timeout=10s --start-period=10s --retries=3 \
  CMD pgrep supercronic > /dev/null || exit 1

# Run supercronic with crontab
CMD ["supercronic", "/app/crontab"]
